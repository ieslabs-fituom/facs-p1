extends main_nonacademic

block content
    .container-fluid.py-4
        .row
            .col-xl-0.col-sm-0.mb-xl-0.mb-4
                .card.px-0.pb-4
                    .card-header.pb-0.pt-3.bg-dark.mb-2
                        h6.text-capitalize.text-center.text-light.font-weight-bolder Add Student Groups

                    .row.px-3
                        .row.mt-2.px-2.justify-content-center
                            .col-xl-4.col-xs-0.my-1
                                h6.text-dark.text-sm.text-center Batch
                                    select#batch_select.form-select.text-xs.me-8.pe-5.ms-0.mt-1.mb-3.lh-lg4(onchange="")
                                        each batch in batches 
                                            option(value=batch.id) Batch #{batch.Batch}
                            .col-xl-4.col-xs-0.my-1
                                h6.text-dark.text-sm.text-center Module
                                    select#module_select.form-select.text-xs.me-8.pe-5.ms-0.mt-1.mb-3.lh-lg4(onchange="")
                                        each module in modules 
                                            option(value=module.id) #{module.Code} - #{module.Name}
                        .row.mt-2.px-2.justify-content-center
                            .col-xl-4.col-xs-0.my-1.text-center
                                h6.text-dark.text-sm.text-center Group Name
                                    input#group_name.form-control.text-xs.me-8.ms-0.mt-1.mb-3.lh-lg.text-center(type='text' value="" placeholder='Enter group name' name='group_name')
                                input(type='checkbox' value='0' name='auto_generate_group_name' id='auto_generate_group_name' onchange="autoGenerateGroupName()")
                                label.form-check-label.text-dark.text-sm(for='auto_generate_group_name') Auto generate group name
                        .row.mt-2.px-2.justify-content-center 
                            each degree, index in degrees
                                .col-xl-2.col-xs-0.my-1.text-center.align-items-center.my-2
                                    input.text-xs.lh-lg(type='checkbox' value=degree.id placeholder='' name='degree' id='degree-' + degree.id)
                                    label.form-check-label.text-dark.text-sm(for='degree-' + degree.id) #{degree.Degree}
                        .row.mt-1.px-2.justify-content-center
                            .col-xl-3.col-xs-0.my-1.text-center
                                input.text-xs.lh-lg(type='radio' value='0' name='filter_student_radio')#filter_student_0
                                label.form-check-label.text-dark.text-sm(for='filter_student_0') Add all students of above filter
                            .col-xl-3.col-xs-0.my-1.text-center
                                input.text-xs.lh-lg(type='radio' value='0' name='filter_student_radio')#filter_student_1
                                label.form-check-label.text-dark.text-sm(for='filter_student_1') Add only selected students
                        .row.mt-3.px-2.justify-content-center
                            .col-lg-0.text-center
                                    button.btn.btn-primary.btn-sm.ps-7.pe-7(onclick="verifyGroupDetails()") Next
                        
                    .row.px-3.invisible
                        .row#add_students_area.mt-2.px-2.justify-content-center
                            .col-xl-4.col-xs-0.my-1
                                h6.text-dark.text-sm.text-center Index Number of The Student
                                    input#index_no.form-control.text-xs.me-8.ms-0.mt-1.mb-3.lh-lg.text-center(type='text' value="" placeholder='Enter Index Number' name='index_no')
                        .row.mt-1.px-2.justify-content-center
                            .col-lg-0.text-center
                                button.btn.btn-primary.btn-sm.ps-7.pe-7(onclick="") Add Student

                        .row#students_row.mt-3
                            .col-lg-0.mb-xl-0.mb-4
                                .table-responsive
                                    //Class limited-rows-table - used to specify the max height and make scrollbars visible
                                    table#students_table.table.align-items-center
                                        tbody#students_table_body

                        // Add hr
                        .row.mt-3.px-2.justify-content-center
                            .d-flex.flex-row.my-3.justify-content-center
                                hr.horizontal.dark.mt-3.w-50

                        .row.mt-1.px-2.justify-content-center
                            .col-lg-3.text-center.mx-2
                                button.btn.btn-primary.btn-sm.ps-7.pe-7(onclick="") Back
                            .col-lg-3.text-center.mx-2
                                button.btn.btn-primary.btn-sm.ps-7.pe-7(onclick="") Next
                        
                    
                                                        

    script.

        var batches,modules,groups,degrees, attendances, lecturers, selectedSessionID; // selectedSessionID - value is assigned for this when an user select a session from session
        $(document).ready(function() {
            batches = JSON.parse(JSON.stringify(!{JSON.stringify(batches)}));
            modules = JSON.parse(JSON.stringify(!{JSON.stringify(modules)}));
            degrees = JSON.parse(JSON.stringify(!{JSON.stringify(degrees)}));
            sideBarChange();
        });

        // HIGHLIGHTING RELATED OPTION IN SIDEBAR
        function sideBarChange(){
            //console.log(modules);
            document.getElementById("students-nav-link").classList.remove('active');
            document.getElementById("today-nav-link").classList.remove('active');
            document.getElementById("pastreports-nav-link").classList.remove('active');
            document.getElementById("students-nav-link").classList.remove('active');
            document.getElementById("semester-nav-link").classList.add('active');
        }

        var win = navigator.platform.indexOf('Win') > -1;
        if (win && document.querySelector('#sidenav-scrollbar')) {
            var options = {
                damping: '0.5'
            }
            Scrollbar.init(document.querySelector('#sidenav-scrollbar'), options);
        }
        
        function verifyGroupDetails(){
            let batch = document.getElementById("batch_select").value;
            let module = document.getElementById("module_select").value;
            let group_name = document.getElementById("group_name").value;

            let selectedDegrees = [];
            for(degree of degrees){
                if(document.getElementById("degree-"+degree.id).checked){
                    selectedDegrees.push(degree.id);
                }
            }

            let filter_type;
            if(document.getElementById("filter_student_0").checked){
                filter_type = 0;
            }else if(document.getElementById("filter_student_1").checked){
                filter_type = 1;
            }

            if(group_name.trim()==''){
                window.alert("Please enter a group name");
                return;
            }
            
            if(selectedDegrees.length==0){
                window.alert("Please select at least one degree");
                return;
            }

            if(filter_type==undefined){
                window.alert("Please select a filter type");
                return;
            }

            //console.log(batch, module, group_name, selectedDegrees, filter_type);

            $.ajax({
                    type: 'GET',
                    url: '/nac/addgroup/verifygroup',
                    //headers: {'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')},
                    data: {
                        batch: batch,
                        module: module,
                        group_name: group_name,
                        degrees: selectedDegrees,
                        filter_type: filter_type
                    },
                    dataType: 'json',
                    encode: true
                }).done(function (response) {
                    console.log(response);
                    if(response.status=='200'){
                        console.log('success');
                        console.log(response.students);
                    }else if(response.status=='201'){
                        window.alert("This group name is already used");
                    }
                });
        }

        function autoGenerateGroupName(){
            let auto_generate_group_name = document.getElementById("auto_generate_group_name").checked;
            let group_name = document.getElementById("group_name");
            if(auto_generate_group_name){
                let selectedBatch = document.getElementById("batch_select").value;
                let selectedModule = document.getElementById("module_select").value;
                let new_name = '';
                for(batch of batches){
                    if(batch.id == selectedBatch){
                        new_name += batch.Batch;
                        break;
                    }
                }
                for(module of modules){
                    if(module.id == selectedModule){
                        new_name += '-' + module.Code;
                        break;
                    }
                }
                group_name.value = new_name;
            }else{
                group_name.value = "";
            }
        }

        function clearSelectOptions(element){
            element.innerHTML = '';
        }